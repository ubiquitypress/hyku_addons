<% template = f.object.model.class.to_s.underscore %>
<% types = HykuAddons::NameTypeService.new.active_elements %>

<!-- _editor_schema -->
<div class="<%= template %>_editor" data-cloneable data-cloneable-min="1">
  <% f.object.editor_list.each do |hash| %>
    <div data-toggleable data-cloneable-group="<%= template %>_editor" data-cloneable-after-action="clear_inputs clear_cloned">
      <% field_options = {
        field_slug: :editor_name_type,
        select_options: types.map { |t| t.slice("label", "id").values },
        field_args: {
          class: "form-control editor_name_type #{template}_editor_editor_name_type", # Required for specs
          data: {
            toggleable_control: true,
            on_change: :toggleable_group,
            after_toggleable_hidden: :clear_inputs,
          }
        },
        field_group: :editor,
        template: template,
        hash: hash
      } %>
    <%= render "records/edit_fields/attribution_partials/select_field", field_options %>

      <% types.each do |type| %>
        <% subfields = f.object.field_configs[:editor][:subfields].select { |subfield, config| config.has_key?(:display_for) && config[:display_for].include?(type[:id].downcase) } %>

        <div data-toggleable-group="<%= type[:id] %>">
          <% subfields.each do |name, config| %>
            <% field = {
              f: f,
              field_type: config[:type],
              field_slug: name.to_sym,
              field_args: {
                data: {
                  required: config[:required],
                  cloneable: config[:multiple]
                }
              }
            } %>

            <% if config[:type] == "select" %>
              <% authority_service = config[:authority]&.safe_constantize %>
              <% field[:select_options] = authority_service.new(model: f.object.model.class).select_active_options if authority_service %>
            <% end %>

            <% options = { field_group: :editor, template: template, hash: hash }.merge(field) %>
            <%= render "records/edit_fields/attribution_partials/#{field[:field_type]}_field", options %>
          <% end %>
        </div>
      <% end %>

    <div class="form-group">
      <a href="#" class="text-danger form-group" data-turbolinks="false" data-on-click="remove_group" data-cloneable-target="<%= template %>_editor">
        <span class="glyphicon glyphicon-remove"></span>
        <span class="controls-remove-text"><%= t("simple_form.deposit_form.form_controls.remove.text") %></span>
      </a>
      |
      <a href="#" data-turbolinks="false" data-cloneable-target="<%= template %>_editor" data-on-click="clone_group">
        <%= t("simple_form.deposit_form.form_controls.add.text") %>
      </a>
    </div>

    <hr>
    </div>
  <% end %>
</div>

